{
	"$schema": "http://json-schema.org/draft-07/schema#",
	"$id": "http://not-things.com/timeseq/0.0.1",
	"definitions": {
		"id-base": {
			"type": "object",
			"properties": {
				"id": {
					"type": "string",
					"minLength": 1
				}
			},
			"required": [ "id" ]
		},
		"ref-base": {
			"type": "object",
			"properties": {
				"ref": {
					"type": "string",
					"minLength": 1
				}
			},
			"required": [ "ref" ]
		},
		"input": {
			"type": "object",
			"properties": {
				"index": {
					"type": "integer",
					"minimum": 0,
					"maximum": 8
				},
				"channel": {
					"type": "integer",
					"minimum": 0,
					"maximum": 8
				}
			},
			"required": [ "index" ]
		},
		"output": {
			"type": "object",
			"properties": {
				"index": {
					"type": "integer",
					"minimum": 0,
					"maximum": 8
				},
				"channel": {
					"type": "integer",
					"minimum": 0,
					"maximum": 8
				}
			},
			"required": [ "index" ]
		},
		"rand": {
			"type": "object",
			"properties": {
				"lower": {
					"oneOf": [
						{ "$ref": "#/definitions/ref-base" },
						{ "$ref": "#/definitions/value" }
					]
				},
				"upper": {
					"oneOf": [
						{ "$ref": "#/definitions/ref-base" },
						{ "$ref": "#/definitions/value" }
					]
				}
			},
			"required": [ "lower", "upper" ]
		},
		"calc": {
			"type": "array",
			"items": {
				"type": "object",
				"properties": {
					"add": {
						"oneOf": [
							{ "$ref": "#/definitions/ref-base" },
							{ "$ref": "#/definitions/value" }
						]
					},
					"sub": {
						"oneOf": [
							{ "$ref": "#/definitions/ref-base" },
							{ "$ref": "#/definitions/value" }
						]
					},
					"div": {
						"oneOf": [
							{ "$ref": "#/definitions/ref-base" },
							{ "$ref": "#/definitions/value" }
						]
					},
					"mult": {
						"oneOf": [
							{ "$ref": "#/definitions/ref-base" },
							{ "$ref": "#/definitions/value" }
						]
					}
				},
				"minProperties": 1,
				"maxProperties": 1
			},
			"minItems": 1
		},
		"value": {
			"type": "object",
			"properties": {
				"voltage": {
					"type": "number",
					"minimum": -10,
					"maximum": 10
				},
				"note": {
					"type": "string",
					"minLength": 2,
					"maxLength": 3,
					"pattern": "[a-zA-Z][0-9][+-]?"
				},
				"input": {
					"oneOf": [
						{ "$ref": "#/definitions/ref-base" },
						{ "$ref": "#/definitions/input" }
					]
				},
				"output": {
					"oneOf": [
						{ "$ref": "#/definitions/ref-base" },
						{ "$ref": "#/definitions/output" }
					]
				},
				"rand": { "$ref": "#/definitions/rand" },
				"calc": {
					"oneOf": [
						{ "$ref": "#/definitions/ref-base" },
						{ "$ref": "#/definitions/calc" }
					]
				}
			},
			"oneOf": [
				{ "required": [ "voltage" ] },
				{ "required": [ "note" ] },
				{ "required": [ "input" ] },
				{ "required": [ "output" ] },
				{ "required": [ "rand" ] }
			]
		},
		"set-value": {
			"type": "object",
			"properties": {
				"output": {
					"oneOf": [
						{ "$ref": "#/definitions/ref-base" },
						{ "$ref": "#/definitions/output" }
					]
				},
				"value": {
					"oneOf": [
						{ "$ref": "#/definitions/ref-base" },
						{ "$ref": "#/definitions/value" }
					]
				}
			},
			"required": [ "output", "value" ]
		},
		"set-polyphony": {
			"type": "object",
			"properties": {
				"index": {
					"type": "integer",
					"minimum": 0,
					"maximum": 8
				},
				"channels": {
					"type": "integer",
					"minimum": 1,
					"maximum": 16
				}
			},
			"required": [ "index", "channels" ]
		},
		"action": {
			"type": "object",
			"properties": {
				"timing": {
					"enum": [ "start", "end", "glide" ]
				},
				"set-value": { "$ref": "#/definitions/set-value" },
				"set-polyphony": { "$ref": "#/definitions/set-polyphony" },
				"trigger": {
					"type": "string"
				},
				"start-value": {
					"oneOf": [
						{ "$ref": "#/definitions/ref-base" },
						{ "$ref": "#/definitions/value" }
					]
				},
				"end-value": {
					"oneOf": [
						{ "$ref": "#/definitions/ref-base" },
						{ "$ref": "#/definitions/value" }
					]
				}
			},
			"required": [ "timing" ],
			"if": {
				"properties": { "timing": { "const": "glide" } }
			},
			"then": {
				"not": { "anyOf": [
					{ "required": [ "timing" ] },
					{ "required": [ "set-value" ] },
					{ "required": [ "set-polyphony" ] },
					{ "required": [ "trigger" ] }
				] }
			},
			"else": {
				"not": { "anyOf": [
					{ "start-value": [ "timing" ] },
					{ "end-value": [ "set-value" ] }
				] }
			}
		},
		"duration": {
			"type": "object",
			"properties": {
				"samples": {
					"type": "integer",
					"exclusiveMinimum": 0
				},
				"millis": {
					"type": "number",
					"exclusiveMinimum": 0
				},
				"bars": {
					"type": "integer",
					"exclusiveMinimum": 0
				},
				"beats": {
					"type": "number",
					"exclusiveMinimum": 0
				}
			},
			"oneOf": [
				{
					"required": [ "samples" ],
					"not": { "anyOf": [
						{ "required": [ "millis" ] },
						{ "required": [ "bars" ] },
						{ "required": [ "beats" ] }
					]}
				},
				{
					"required": [ "millis" ],
					"not": { "anyOf": [
						{ "required": [ "samples" ] },
						{ "required": [ "bars" ] },
						{ "required": [ "beats" ] }
					]}
				},
				{
					"required": [ "beats" ],
					"not": { "anyOf": [
						{ "required": [ "millis" ] },
						{ "required": [ "samples" ] }
					]}
				}
			]
		},
		"segment": {
			"type": "object",
			"properties": {
				"duration": { "$ref": "#/definitions/duration" },
				"actions": {
					"type": "array",
					"items": {
						"oneOf": [
							{ "$ref": "#/definitions/ref-base" },
							{ "$ref": "#/definitions/action" }
						]
					},
					"minItems": 1
				}
			},
			"required": [ "duration" ]
		},
		"segment-block": {
			"type": "object",
			"properties": {
				"segments": {
					"type": "array",
					"items": {
						"type": "object",
						"properties": {
							"segment": {
								"oneOf": [
									{ "$ref": "#/definitions/ref-base" },
									{ "$ref": "#/definitions/segment" }
								]
							},
							"segment-block": {
								"oneOf": [
									{ "$ref": "#/definitions/ref-base" },
									{ "$ref": "#/definitions/segment-block" }
								]
							}
						},
						"minProperties": 1,
						"maxProperties": 1
					}
				}
			},
			"required": [ "segments" ]
		},
		"lane": {
			"type": "object",
			"properties": {
				"loop": {
					"type": "boolean"
				},
				"repeat": {
					"type": "integer",
					"minimum": 1
				},
				"start-trigger": {
					"type": "string",
					"minLength": 1
				},
				"stop-trigger": {
					"type": "string",
					"minLength": 1
				},
				"segments": {
					"type": "array",
					"items": {
						"type": "array",
						"items": {
							"type": "object",
							"properties": {
								"segment": {
									"oneOf": [
										{ "$ref": "#/definitions/ref-base" },
										{ "$ref": "#/definitions/segment" }
									]
								},
								"segment-block": {
									"oneOf": [
										{ "$ref": "#/definitions/ref-base" },
										{ "$ref": "#/definitions/segment-block" }
									]
								}
							},
							"minProperties": 1,
							"maxProperties": 1
						}
					}
				}
			},
			"required": [ "segments" ]
		},
		"time-scale": {
			"type": "object",
			"properties": {
				"sample-rate": {
					"type": "integer",
					"minimum": 1
				},
				"bpm": {
					"type": "integer",
					"minimum": 1
				},
				"bpb": {
					"type": "integer",
					"minimum": 1
				}
			},
			"oneOf": [
				{
					"required": [ "sample-rate" ],
					"not": {
						"anyOf": [
							{ "required": [ "bpm" ] },
							{ "required": [ "bpb" ] }
						]
					}
				},
				{
					"required": [ "bpm" ],
					"not": {
						"anyOf": [
							{ "required": [ "sample-rate" ] },
							{ "required": [ "bpb" ] }
						]
					}
				},
				{
					"required": [ "bpm", "bpb" ],
					"not": { "required": [ "sample-rate" ] }
				}
			]
		},
		"timeline": {
			"type": "object",
			"properties": {
				"time-scale": { "$ref": "#/definitions/time-scale" },
				"loop-lock": {
					"type": "boolean"
				},
				"lanes": {
					"type": "array",
					"items": {
						"$ref": "#/definitions/lane"
					},
					"minItems": 1
				}
			},
			"required": [ "lanes" ]
		},
		"input-trigger": {
			"type": "object",
			"properties": {
				"id": {
					"type": "string",
					"minLength": 1
				},
				"input": {
					"oneOf": [
						{ "$ref": "#/definitions/ref-base" },
						{ "$ref": "#/definitions/input" }
					]
				}
			},
			"required": [ "id", "input" ]
		},
		"script": {
			"type": "object",
			"properties": {
				"type": {
					"const": "not-things_timeseq_script"
				},
				"version": {
					"const": "0.0.1"
				},
				"timelines": {
					"type": "array",
					"items": {
						"$ref": "#/definitions/timeline"
					},
					"minItems": 1
				},
				"segment-blocks": {
					"type": "array",
					"items": {
						"allOf": [
							{ "$ref": "#/definitions/id-base" },
							{ "$ref": "#/definitions/segment-block" }
						]
					},
					"minItems": 1
				},
				"segments": {
					"type": "array",
					"items": {
						"allOf": [
							{ "$ref": "#/definitions/id-base" },
							{ "$ref": "#/definitions/segment" }
						]
					},
					"minItems": 1
				},
				"inputs": {
					"type": "array",
					"items": {
						"allOf": [
							{ "$ref": "#/definitions/id-base" },
							{ "$ref": "#/definitions/input" }
						]
					},
					"minItems": 1
				},
				"outputs": {
					"type": "array",
					"items": {
						"allOf": [
							{ "$ref": "#/definitions/id-base" },
							{ "$ref": "#/definitions/output" }
						]
					},
					"minItems": 1
				},
				"calcs": {
					"type": "array",
					"items": {
						"allOf": [
							{ "$ref": "#/definitions/id-base" },
							{ "$ref": "#/definitions/calc" }
						]
					},
					"minItems": 1
				},
				"values": {
					"type": "array",
					"items": {
						"allOf": [
							{ "$ref": "#/definitions/id-base" },
							{ "$ref": "#/definitions/value" }
						]
					},
					"minItems": 1
				},
				"actions": {
					"type": "array",
					"items": {
						"allOf": [
							{ "$ref": "#/definitions/id-base" },
							{ "$ref": "#/definitions/action" }
						]
					},
					"minItems": 1
				},
				"input-triggers": {
					"type": "array",
					"items": {
						"$ref": "#/definitions/input-trigger"
					},
					"minItems": 1
				}
			},
			"required": [ "type", "version", "timelines" ]
		}
	},
	"$ref": "#/definitions/script"
}
